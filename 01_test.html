<!DOCTYPE html>
<html>
	<head>
		<title>k MapTest01</title>
		<meta charset="utf-8">
		<style>
			.map {
				border: 2px outset blue;
				background-color:black;
			}
			.ui {
				border: 2px outset blue;
				background-color:rgb(151, 151, 151);
			}
		</style>
		
	</head>

	<body>
		<h2><a title="Back" href="index.html">Back</a></h2>

		<div class="ui" id="ui" style="width:100%;height:160px;">
			<p>
				<label>Zoom
					<label><input onclick="setZoomable(true)" type="radio" name="zoom" value="on"> ON</label>
					<label><input onclick="setZoomable(false)" type="radio" name="zoom" value="off"> OFF</label>
				</label>
			</p>
			<p>
				<label>Move
					<label><input onclick="setDraggable(true)" type="radio" name="move" value="on"> ON</label>
					<label><input onclick="setDraggable(false)" type="radio" name="move" value="off"> OFF</label>
				</label>
			</p>
			<p>
				<button onclick="toggleOverlayMapTypeId('terrain')">지형정보 보기</button>
				<button onclick="toggleOverlayMapTypeId('use_district')">지적편집도 보기</button>
			</p> 
			
			<p>
				<label for="cars">Choose a car:</label>
	
				<select name="cars" id="cars">
					<option value="volvo">Volvo</option>
					<option value="saab">Saab</option>
					<option value="mercedes">Mercedes</option>
					<option value="audi">Audi</option>
				</select>
			</p>
		</div>
		
		<div class="map" id="map" style="width:100%;height:700px;">
		</div>
		<p><em>지도를 클릭해주세요!</em></p> 
		<div id="clickLatlng"></div>
		<div id="clickAddress"></div>
		
		
		<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d3570968e771fd13fd7907f546f19c06&libraries=services,clusterer,drawing">
			//appkey == JavaScript 키
		</script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js">
			//엑셀을 읽기위해 라이브러리 추가.
		</script>


		<input type="file" id="excelFile" onchange="excelExport(event)"/>
		<script>
			//37.58468807390984
			//126.96640550469013
			let lat = 37.498004414546934;
			let lng = 127.02770621963765;

			let markers = new Map();
			let markerImages = [];

		</script>
		<script type="text/javascript" src="kakao_map.js"></script>
		
		<script>

			let imageSize = new kakao.maps.Size(72, 72);
			let imageOptions = {  
                spriteOrigin: new kakao.maps.Point(0, 0),    
                spriteSize: new kakao.maps.Size(72, 72)  
            }; 
			let markerImg = createMarkerImage('mask-50.png', imageSize, imageOptions);

			function addMarker(address, coord) {
				var marker = new kakao.maps.Marker({ position: coord });
				marker.setImage(markerImg);

				marker.setMap(map);
				//console.log(marker);
				
				//var marker = new kakao.maps.Marker({ position: coord });
				//marker.setMap(map);

				clusterer.addMarker(marker);
				 
				markers.set(address, marker);
			}

			function remMarker(address) {
				var marker = markers.get(address);
				if (marker)
				{
					clusterer.removeMarker(marker);
					marker.setMap(null);
					markers.delete(address);
				}
			}
			
			function excelExport(event){
				var input = event.target;
				var reader = new FileReader();
				reader.onload = function(){
					var fileData = reader.result;
					var wb = XLSX.read(fileData, {type : 'binary'});
					//wb.SheetNames.forEach(function(sheetName){
					//	console.log('sheetName : '+sheetName);
					//	var rowObj =XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
					//	console.log(rowObj);
					//})
					var rowObj =XLSX.utils.sheet_to_json(wb.Sheets['경작지']);
					rowObj.forEach(function(element){
						var addr = element['경작지_1'];

						var lat2;
						var lng2;
						addrToCoords(addr,  function(result, status) {
							
							if (status === kakao.maps.services.Status.OK) {

								var ret = result[0];

								if (result.length > 1)
								{
									var ret2 = result.find(e => e.address_name.indexOf('경북 상주시 모서면') >= 0);
									if(!ret2)
									{
										ret2 = result.find(e => e.address_name.indexOf('경북 상주시') >= 0);
										//console.log('2nd try');
										//console.log(ret2);
									}
									
									if(!ret2)
									{
										ret2 = result.find(e => e.address_name.indexOf('경북') >= 0);
										//console.log('3rd try');
										//console.log(ret2);
									}
									if (ret2)
									{
										ret = ret2;
										//console.log('--->>> found :' + ret.address_name);
									}
									else
									{
										//console.log('===>>> not fund :' + addr);
										//console.log(result);
									}
								}
								let lat = ret.y;
								let lng = ret.x;
								panTo(lat, lng);
								var coords = new kakao.maps.LatLng(ret.y, ret.x);
								addMarker(ret.address_name, coords);
								//console.log("--@{");
								if (ret.address_name.indexOf('경북 상주시 모서면') < 0)
								{
									console.log('============ :' + addr + " >> " + ret.address_name);
									console.log(result);
								}
								//console.log("--@}");
							}
							else
							{
								console.log('===>>> not fund :' + addr);
								console.log(status);
								console.log(result);
							}
						});
					});
				};
				reader.readAsBinaryString(input.files[0]);
			}
			
			infowindow = new kakao.maps.InfoWindow({zindex:1}); // 클릭한 위치에 대한 주소를 표시할 인포윈도우입니다
			
			lat = 35.49797376993066;
			lng = 127.02743804862237;
			panTo(lat, lng);

			////득수리0118-0004
			//addrToCoords('경상북도 상주시 모서면 득수리 산118-4',  function(result, status) {
			//	lat = result[0].y;
			//	lng = result[0].x;
			//	panTo(lat, lng);
			//	var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
			//	addMarker(result[0].address_name, coords);
			//	console.log("--@{");
			//	console.log(result);
			//	console.log("--@}");
			//});

			map.setLevel(1);
			toggleOverlayMapTypeId('use_district');


			// 지도에 클릭 이벤트를 등록합니다
			// 지도를 클릭하면 마지막 파라미터로 넘어온 함수를 호출합니다
			kakao.maps.event.addListener(map, 'click', function(mouseEvent) {        
				
				// 클릭한 위도, 경도 정보를 가져옵니다 
				var latlng = mouseEvent.latLng; 
				
				var message = 'Lat : ' + latlng.getLat();
				message += ', Lng : ' + latlng.getLng();
				
				var resultDiv = document.getElementById('clickLatlng'); 
				resultDiv.innerHTML = message;

				searchDetailAddrFromCoords(latlng, function(result, status) {
					if (status === kakao.maps.services.Status.OK) {
						const address = result[0].address.address_name;

						
						var resultDiv = document.getElementById('clickAddress'); 
						resultDiv.innerHTML = address;

						addrToCoords(address,  function(result, status) {
							var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
							
							if (markers.has(address))
							{
								remMarker(address);
							}
							else
							{
								addMarker(address, coords);
								panTo(result[0].y, result[0].x);
							}
						});
					}
				});
				/*
				searchDetailAddrFromCoords(latlng, function(result, status) {
					
					if (status === kakao.maps.services.Status.OK) {
						var detailAddr = !!result[0].road_address ? '<div>도로명주소 : ' + result[0].road_address.address_name + '</div>' : '';
						detailAddr += '<div>지번 주소 : ' 
							+ result[0].address.address_name
							+ '</div>';
						
						var content = '<div class="bAddr">' +
										'<span class="title">법정동 주소정보</span>' + 
										detailAddr + 
									'</div>';

						// 마커를 클릭한 위치에 표시합니다 
						marker.setPosition(mouseEvent.latLng);
						marker.setMap(map);
						console.log(result);

						panTo(latlng.getLat(), latlng.getLng())

						// 인포윈도우에 클릭한 위치에 대한 법정동 상세 주소정보를 표시합니다
						infowindow.setContent(content);
						infowindow.open(map, marker);
					} 
				});
				//*/
			});

			


		</script>

		<!--
		-->

	</body>
</html>
